<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Komunikator z Wysyłaniem Plików</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{
    --bg-url: url('https://i.postimg.cc/7h5bjznF/4022.png');
    --glass-blur: 18px;
    --glass-opacity: 0.15;
    --accent: linear-gradient(90deg, rgba(98,87,234,0.9), rgba(8,185,214,0.9));
    --ui-font: 'Poppins', system-ui, sans-serif;
  }
  html,body{ height:100%; margin:0; font-family:var(--ui-font); color:#fff; overflow:hidden; }
  body::before{ content:""; position:fixed; inset:0; z-index:-2; background-image: var(--bg-url); background-size: cover; background-position: center; filter: brightness(1) saturate(1.05); }
  #glassControl{ position:absolute; top:12px; right:20px; z-index:10; width:160px; appearance:none; height:6px; border-radius:6px; background:rgba(255,255,255,0.25); outline:none; cursor:pointer; }
  #glassControl::-webkit-slider-thumb{ appearance:none; width:16px; height:16px; border-radius:50%; background:#fff; border:2px solid #62b; cursor:pointer; }
  .wrap{ position:relative; z-index:5; width:100%; height:100%; display:flex; flex-direction:column; max-width: 800px; margin: 0 auto; }
  .panel{ flex:1; display:flex; flex-direction:column; overflow:hidden; background:rgba(20, 20, 30, var(--glass-opacity)); border-radius:20px; margin:12px; box-shadow:0 8px 32px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.12); backdrop-filter:blur(var(--glass-blur)); transition: background 0.3s ease, backdrop-filter 0.3s ease; }
  header.top{ display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); backdrop-filter:blur(6px); border-radius:20px 20px 0 0; }
  header.top h1{ margin:0; font-size:16px; font-weight:600; }
  header.top #chatIdDisplay { font-size: 12px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 8px; user-select: all; }
  .messages{ flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; }
  .msg{ max-width:80%; padding:12px 14px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.35); font-size:15px; line-height:1.5; opacity:0; transform:translateY(20px); animation: fadeInUp 0.4s ease forwards; word-wrap: break-word; }
  .msg:not(.own){ background:rgba(40,40,60,0.45); align-self:flex-start; }
  .msg.own{ background:linear-gradient(135deg,rgba(0,200,120,0.9),rgba(0,150,200,0.9)); align-self:flex-end; color:#fff; }
  .msg .author { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: block; }
  .msg img.chat-image { max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer; }
  .msg a.file-link { display: block; margin-top: 8px; color: #a0e0ff; text-decoration: none; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; }
  .msg a.file-link:hover { background: rgba(0,0,0,0.4); }
  @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
  .composer{ display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,0.12); align-items:center; background:rgba(0,0,0,0.15); backdrop-filter:blur(6px); border-radius:0 0 20px 20px; }
  textarea.input{ flex:1; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.2); resize:none; font-size:14px; max-height:90px; }
  .btn{ padding:10px 14px; border-radius:12px; background:var(--accent); border:none; color:#fff; font-size:14px; font-weight:500; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.35); }
  .btn:disabled { background: #555; cursor: not-allowed; }
  .icon-btn{ width:42px; height:42px; padding:0; border-radius:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .3s ease; color:white; font-size:20px; }
</style>
</head>
<body>
  <input id="glassControl" type="range" min="4" max="30" step="1" value="18">
  <div class="wrap">
    <div class="panel">
      <header class="top">
        <h1>Komunikator</h1>
        <div id="chatIdDisplay">Ładowanie...</div>
      </header>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <label class="icon-btn" title="Dodaj zdjęcie"><i class="fa-solid fa-image"></i><input id="imgInput" type="file" accept="image/*" style="display:none"></label>
        <label class="icon-btn" title="Dodaj plik"><i class="fa-solid fa-paperclip"></i><input id="fileInput" type="file" style="display:none"></label>
        <textarea id="textInput" class="input" placeholder="Wpisz wiadomość..." rows="1"></textarea>
        <button id="sendBtn" class="btn">Wyślij</button>
      </div>
    </div>
  </div>
<script type="module">
  // Poprawna konfiguracja z projektu "superkomunikator-2025"
  const firebaseConfig = {
    apiKey: "AIzaSyCsPaxiGkrtx50V0k42pYPueXpwO523RXU",
    authDomain: "superkomunikator-2025.firebaseapp.com",
    projectId: "superkomunikator-2025",
    storageBucket: "superkomunikator-2025-pliki", 
    messagingSenderId: "743497254229",
    appId: "1:743497254229:web:c43976ddadba766a6f9bdc"
  };
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, setPersistence, browserLocalPersistence, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatIdDisplay = document.getElementById('chatIdDisplay');
  const glassControl = document.getElementById('glassControl');
  const imgInput = document.getElementById('imgInput');
  const fileInput = document.getElementById('fileInput');
  
  let currentUserId = null, chatId = null, unsubscribe = null;
  
  async function initializeAuthAndChat() {
    try { await setPersistence(auth, browserLocalPersistence); } 
    catch (error) { console.error("Nie udało się ustawić trwałego logowania:", error); }
    
    onAuthStateChanged(auth, user => {
      if (user) { currentUserId = user.uid; setupChat(); } 
      else { signInAnonymously(auth).catch(e => console.error("Błąd logowania:", e)); }
    });
  }
  
  initializeAuthAndChat();
  
  function setupChat() {
    chatId = window.location.hash.substring(1) || `chat_${Math.random().toString(36).substring(2, 10)}`;
    window.location.hash = chatId;
    chatIdDisplay.textContent = `ID Czatu: ${chatId}`;
    if (unsubscribe) unsubscribe();
    const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp'));
    unsubscribe = onSnapshot(q, snapshot => {
      messagesEl.innerHTML = '';
      snapshot.forEach(doc => renderMessage(doc.data()));
      if (messagesEl.scrollHeight > messagesEl.clientHeight) {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }, error => console.error("Błąd nasłuchiwania:", error));
  }
  
  function renderMessage(msg) {
    const d = document.createElement('div');
    d.className = 'msg' + (msg.userId === currentUserId ? ' own' : '');
    const authorId = `...${msg.userId.slice(-5)}`;
    let content = `<span class="author">User: ${authorId}</span>`;
    
    if (msg.type === 'image') { content += `<img src="${msg.url}" class="chat-image" alt="wysłane zdjęcie">`; } 
    else if (msg.type === 'file') { content += `<a href="${msg.url}" class="file-link" target="_blank" rel="noopener noreferrer">Pobierz plik: ${msg.name}</a>`; } 
    else { content += `<div class="text">${msg.text}</div>`; }
    d.innerHTML = content;
    messagesEl.appendChild(d);
  }

  async function uploadFile(file) {
    if (!chatId || !currentUserId || !file) return;
    sendBtn.disabled = true;
    sendBtn.textContent = 'Wysyłam...';
    
    const storageRef = ref(storage, `chats/${chatId}/${Date.now()}_${file.name}`);
    
    try {
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, 'chats', chatId, 'messages'), {
            type: file.type.startsWith('image/') ? 'image' : 'file',
            url: url,
            name: file.name,
            userId: currentUserId,
            timestamp: serverTimestamp()
        });
    } catch (e) { console.error("Błąd wysyłania pliku:", e); } 
    finally { sendBtn.disabled = false; sendBtn.textContent = 'Wyślij'; }
  }

  async function sendMessage() {
    const text = textInput.value.trim();
    if (!text || !currentUserId) return;
    try {
      await addDoc(collection(db, 'chats', chatId, 'messages'), {
        type: 'text', text: text, userId: currentUserId, timestamp: serverTimestamp()
      });
      textInput.value = '';
    } catch (e) { console.error("Błąd wysyłania tekstu:", e); }
  }
  
  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
  glassControl.addEventListener('input', e => document.documentElement.style.setProperty('--glass-blur', e.target.value + 'px'));
  imgInput.addEventListener('change', e => { if (e.target.files[0]) uploadFile(e.target.files[0]); });
  fileInput.addEventListener('change', e => { if (e.target.files[0]) uploadFile(e.target.files[0]); });
</script>
</body>
</html>



